trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  dockerRegistry: 'myregistry.azurecr.io'
  imageName: 'demo-app'
  tag: '$(Build.BuildId)'  # Automatically changes every build

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'

- script: |
    pip install -r requirements.txt
  displayName: 'Install dependencies'

# ---- Run tests ----
- script: |
    python -m unittest discover
  displayName: 'Run tests'

# ---- SonarQube analysis ----
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'Sonar-Service-Connection'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: 'demo-app'
    cliProjectName: 'demo-app'
    cliSources: '.'

- task: SonarQubeAnalyze@5

- task: SonarQubePublish@5
  inputs:
    pollingTimeoutSec: '300'

# ---- Docker build and push ----
- task: Docker@2
  displayName: Build and Push
  inputs:
    command: buildAndPush
    repository: $(dockerRegistry)/$(imageName)
    dockerfile: '**/Dockerfile'
    tags: |
      $(tag)

# ---- Update GitOps manifest ----
- script: |
    git config user.email "devops@company.com"
    git config user.name "Azure DevOps Pipeline"

    sed -i "s/{{TAG}}/$(tag)/g" k8s/deployment.yaml

    git add k8s/deployment.yaml
    git commit -m "Update image tag to $(tag)"
    git push origin main
  displayName: 'Update manifest for ArgoCD'
